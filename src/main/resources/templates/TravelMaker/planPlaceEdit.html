<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
  <title>ì¼ì • ìˆ˜ì •</title>
  <link rel="stylesheet" href="/css/common/reset.css" />
  <link rel="stylesheet" href="/css/TravelMaker/planPlace.css" />
  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=yw4z47fg6r"></script>
  <script type="module" src="/js/TravelMaker/planPlaceEdit.js"></script>
</head>

<body>

  <form id="finalForm" action="final" method="post" style="display: none;">
    <input type="text" id="managementId" name="managementId">
    <input type="text" id="planId" name="planId">
    <input type="text" id="trvlStd" name="trvlStd">
    <input type="text" id="trvlLsd" name="trvlLsd">
    <input type="text" id="ragionNm" name="ragionNm">
  </form>

  <div class="travel_maker">
    <div class="left-container">
      <!-- id ì¶”ê°€ -->
      <div class="left_top">
        <h2 id="planRagion" th:text="${ragionNm}"></h2>
        <button id="register_btn">ìˆ˜ì •</button>
      </div>
      <div class="date">
        <span th:text="${trvlStd}" class="trvlStd">ì‹œì‘ë‚ ì§œ</span>
        <span>~</span>
        <span th:text="${trvlLsd}" class="trvlLsd">ì¢…ë£Œë‚ ì§œ</span>
      </div>
      <div id="search">
        <div class="search_box">
          <input type="search" class="input_text" name="" id="" />
          <button class="input_button">ê²€ìƒ‰</button>
        </div>
      </div>

      <div class="cate">
        <select name="cate_select">
          <option value="A00">ì „ì²´</option>
          <option value="A01">ê´€ê´‘ì§€</option>
          <option value="A02">ë¬¸í™”ì‹œì„¤</option>
          <option value="A03">ì¶•ì œ/ê³µì—°/í–‰ì‚¬</option>
          <option value="A04">ë ˆí¬ì¸ </option>
          <option value="A05">ìˆ™ë°•</option>
          <option value="A06">ì‡¼í•‘</option>
          <option value="A07">ìŒì‹</option>
        </select>
        <select name="food_select">
          <option value="A07">ì „ì²´</option>
          <option value="A0701">í•œì‹</option>
          <option value="A0702">ì„œì–‘ì‹</option>
          <option value="A0703">ì¼ì‹</option>
          <option value="A0704">ì¤‘ì‹</option>
          <option value="A0705">ì´ìƒ‰ìŒì‹ì </option>
          <option value="A0706">ì¹´í˜/ì „í†µì°»ì§‘</option>
          <option value="A0707">í´ëŸ½</option>
        </select>
      </div>

      <div class="item_wrap">
        <!-- item ë°˜ë³µ ì‹œì‘-->
        <!-- */
      <div class="item">
        <img src="/img/logo.png" alt="ì´ë¯¸ì§€" />
        <span>ì œëª©</span>
        <div class="check-button"></div>
      </div>
      */ -->
        <!-- item ë°˜ë³µ ë -->
      </div>

      <div id="pagination"></div>
    </div>

    <div class="plan-container">
      <div class="plan_title">
        <th:block th:each="i : ${#numbers.sequence(1, day)}">
          <input type="radio" name="tabmenu" th:id="'tab0' + ${i}" th:checked="${i == 1}">
          <label th:for="'tab0' + ${i}">[[${i}]]ì¼ì°¨</label>
        </th:block>
      </div>

      <th:block th:each="i : ${#numbers.sequence(1, day)}">
        <div th:class="'conbox con' + ${i}">
          <form th:id="'form' + ${i}" class="plan_wrap">

            <!-- í•´ë‹¹ ì¼ì°¨ì— ë§ëŠ” ì•„ì´í…œë§Œ ë°˜ë³µ -->
            <div class="item" th:each="trvlItem : ${trvlPlans}" th:if="${trvlItem.trvlDay} == ${i}"
              th:data-trvl-x="${trvlItem.trvlX}" th:data-trvl-y="${trvlItem.trvlY}" th:data-trvl-id="${trvlItem.trvlCd}">
              <div class="circle-button">1</div>
              <img class="img" th:src="${trvlItem.img != null} ? ${trvlItem.img} : '/img/main_logo.png'" />
              <span th:text="${trvlItem.trvlNm}">ì—¬í–‰ì§€ì´ë¦„</span>
              <div class="button-wrap">
                <div class="distance-button">ğŸ—ºï¸</div>
                <div class="delete-button">âŒ</div>
              </div>
            </div> <!-- ì•„ì´í…œ ë°˜ë³µ ë -->

          </form>
        </div>
      </th:block>
    </div>



    <div id="map"></div>

  </div>


  <!-- ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ-->
  <template id="trvlItem">
    <div class="item">
      <img src="" alt="ì´ë¯¸ì§€" />
      <span></span>
      <div class="check-button"></div>
    </div>
  </template>

  <script type="module" th:inline="javascript" async>
    import { Pagination } from "/js/common/paging.js";
    const pagination = new Pagination(8, 5);

    const cateSelect = document.querySelector(
      'select[name="cate_select"]'
    );
    const foodSelect = document.querySelector(
      'select[name="food_select"]'
    );

    // ì¹´í…Œê³ ë¦¬ê°’ ì €ì¥í•  ë³€ìˆ˜
    let selectedValue = "A00";
    let keyword = "";
    let trvlX = 0.0;
    let trvlY = 0.0;

    // ì§€ì—­ë³„ ì—¬í–‰ì§€ ëª¨ë‘ ë¶ˆëŸ¬ì˜¤ê¸°
    fetchRagionTravelSpots();

    async function fetchRagionTravelSpots() {
      const reqPage = pagination.currentPage; //ìš”ì²­ í˜ì´ì§€
      const reqCnt = pagination.recordsPerPage;
      const ragion =
        document.getElementById("planRagion").textContent;

      const data = {
        reqPage: reqPage,
        reqCnt: reqCnt,
        ragion: ragion,
        keyword: keyword,
        tagValue: selectedValue,
        trvlX: trvlX,
        trvlY: trvlY,
      };

      const url = `http://localhost:9080/api/travelmaker/all`;
      try {
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json", // JSON í˜•ì‹ìœ¼ë¡œ ìš”ì²­ì„ ë³´ë‚´ê¸° ìœ„í•œ í—¤ë” ì„¤ì •
          },
          body: JSON.stringify(data),
        });
        const result = await res.json();
        //  ìš”ì²­ë° ì‘ë‹µì„±ê³µ
        if (result.header.rtcd == "00") {
          console.log(result);
          // ê¸°ì¡´ì˜ item_wrap ì•ˆì—ìˆë˜ ì•„ì´í…œ ë‹¤ ì‚­ì œ
          const itemLst = document.querySelectorAll(".item_wrap");
          itemLst.forEach((item) => {
            while (item.firstChild) {
              item.removeChild(item.firstChild);
            }
          });

          result.body.forEach((item) => {
            console.log(item);
            const $trvlItem = document
              .getElementById("trvlItem")
              .content.cloneNode(true)
              .querySelector(".item");
            $trvlItem.dataset.trvlId = item.trvlCd;
            $trvlItem.dataset.trvlX = item.trvlX;
            $trvlItem.dataset.trvlY = item.trvlY;

            // $trvlItem.querySelector("img").src = item.img;
            // ëŒ€ì²´ ì´ë¯¸ì§€ ì„¤ì •
            const imgElement = $trvlItem.querySelector("img");
            imgElement.src = item.img
              ? item.img
              : "/img/main_logo.png";

            $trvlItem.querySelector("span").textContent =
              item.trvlNm;

            document
              .querySelector(".item_wrap")
              .appendChild($trvlItem);
          });
          pagination.setTotalRecords(result.totalCnt);
          pagination.displayPagination(fetchRagionTravelSpots);
        } else {
          new Error("ëª©ë¡ ì‹¤íŒ¨!!");
        }
      } catch (err) {
        console.log(err.message);
      } finally {
      }
    }

    // ê²€ìƒ‰, ê±°ë¦¬ìˆœì •ë ¬ ì´ë²¤íŠ¸ë°œìƒ ì½”ë“œ
    // -----------------------------------------------------------

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document
      .querySelector(".input_button")
      .addEventListener("click", function (event) {
        event.preventDefault();

        // ì¹´í…Œê³ ë¦¬ê°’ ë¶ˆëŸ¬ì™€ì„œ SelectedValueì— ì €ì¥
        if (
          cateSelect.value === "A07" &&
          foodSelect.style.display === "block" &&
          foodSelect.value !== "A07"
        ) {
          selectedValue = foodSelect.value;
        } else {
          selectedValue = cateSelect.value;
        }
        keyword = document
          .querySelector(".input_text")
          .value.trim();
        console.log("Selected Value:", selectedValue);
        console.log("keyword:", keyword);
        pagination.currentPage = 1;
        pagination.setCurrentPageGroupStart(1);
        fetchRagionTravelSpots();
      });

    // Enter í‚¤ ì…ë ¥ ì‹œ í¼ ì œì¶œ
    document.addEventListener("keypress", function (event) {
      if (event.key === "Enter") {
        document.querySelector(".input_button").click(); // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ
      }
    });

    // ê±°ë¦¬ìˆœì •ë ¬ë²„íŠ¼ ëˆ„ë¥´ë©´ ì„ íƒí•œ ì—¬í–‰ì§€ ë°˜ê²½ 3kmì´ë‚´ì˜ ì—¬í–‰ì§€ ì¶”ì²œ
document.querySelector('.plan-container').addEventListener('click', function(event) {
    // í´ë¦­ëœ ìš”ì†Œê°€ distance-button í´ë˜ìŠ¤ë¥¼ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸
    if (event.target.classList.contains('distance-button')) {
        let item = event.target.closest(".item");
        console.log(item);

        keyword = "";
        selectedValue = "A00";
        trvlX = item.getAttribute("data-trvl-x");
        trvlY = item.getAttribute("data-trvl-y");
        pagination.currentPage = 1;
        pagination.setCurrentPageGroupStart(1);
        fetchRagionTravelSpots();
    }
});



    // ì—¬í–‰ì¼ì • ìµœì¢… ë“±ë¡
    document.getElementById('register_btn').addEventListener('click', function () {

      const planWraps = document.querySelectorAll('.plan_wrap');
    let isEmptyFound = false;

     // ëª¨ë“  plan_wrap ìš”ì†Œë¥¼ ê²€ì‚¬í•˜ì—¬ ìì‹ ìš”ì†Œì˜ ìœ ë¬´ë¥¼ í™•ì¸
    for (const wrap of planWraps) {
    if (wrap.children.length === 0) {
      isEmptyFound = true;
      break;
    }
  }

  // í•˜ë‚˜ë¼ë„ ìì‹ ìš”ì†Œê°€ ì—†ëŠ” plan_wrapì´ ìˆë‹¤ë©´ ê²½ê³ ì°½ í‘œì‹œ
  if (isEmptyFound) {
    alert('ì¼ì°¨ë³„ë¡œ 1ê°œ ì´ìƒì˜ ì—¬í–‰ì§€ë¥¼ ë„£ì–´ì£¼ì„¸ìš”');
    return; // ì—¬ê¸°ì—ì„œ í•¨ìˆ˜ ì‹¤í–‰ì„ ì¤‘ë‹¨
  } 



      const formattedStd = formatDate(document.querySelector(".trvlStd").textContent);
      const formattedLsd = formatDate(document.querySelector(".trvlLsd").textContent);

      // ê²°ê³¼ ë¬¸ìì—´ì„ ë§Œë“­ë‹ˆë‹¤.
      const result = `${formattedStd} ~ ${formattedLsd}`;

      function collectFormData() {
        const formData = {
          planTabs: [],
          plan_id: [[${ planId }]],
          ragion_nm: [[${ ragionNm }]],
          planDays: result,
        };
        let day = 1;
        let pmId = 1;
        document.querySelectorAll('.conbox').forEach(tabDiv => {
          const items = [];

          tabDiv.querySelectorAll('.item').forEach(itemDiv => {
            const planItem = {
              trvl_id: itemDiv.getAttribute('data-trvl-id'),
              trvl_x: itemDiv.getAttribute('data-trvl-x'),
              trvl_y: itemDiv.getAttribute('data-trvl-y'),
              trvl_day: day.toString(),
              trvl_time: "00000000",
              trvl_stime: "00000000",
              comment: ""

            };
            pmId += 1;
            // itemDiv.querySelectorAll('input[type="text"]').forEach(input => {
            //    planItem[input.name] = input.value;
            // });
            items.push(planItem);
          });
          formData.planTabs.push({ planItems: items });
          day += 1;

        });
        return formData;
      }


      const formData = collectFormData();
      console.log(JSON.stringify(formData));
      savePlan();

      async function savePlan() {
        try {
          const url = 'http://localhost:9080/api/travelmaker/update/planner';
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
          })
          const result = await res.json();
          if (result.header.rtcd == "00") {
            console.log(result);

            document.getElementById('managementId').value = result.body.managementId;
            document.getElementById('planId').value = result.body.planId;
            document.getElementById('trvlStd').value = result.body.trvlStd;
            document.getElementById('trvlLsd').value = result.body.trvlLsd;
            document.getElementById('ragionNm').value = result.body.ragionNm;


            // í¼ ìë™ ì œì¶œ (í•„ìš”í•œ ê²½ìš°)
            document.getElementById('finalForm').submit();

          }
          else {
            new Error("ëª©ë¡ ì‹¤íŒ¨!!");
          }
        }
        catch (error) {
          console.error('Error:', error);
        }
      }

    });


    // ë‚ ì§œë¥¼ "YYYY-MM-DD" í˜•ì‹ì—ì„œ "Mì›”Dì¼" í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
function formatDate(dateStr) {
    const date = new Date(dateStr);
    const month = date.getMonth() + 1; // ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ 1ì„ ë”í•©ë‹ˆë‹¤.
    const day = date.getDate();
    return `${month}ì›” ${day}ì¼`;
}










  </script>
</body>

</html>